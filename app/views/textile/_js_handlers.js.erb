$(function() {
  var $textileData = $('.textile').data('plugin_textile');
  var typingTimer;

  // Handler for deleting the field row
  $('[data-behavior~=delete-field]').click( function(){
    $(this).closest('[data-behavior~=textile-form-field]').remove();
    $textileData._loadPreview({ form: $textileData._serializedFormData() })
  });

  // Handler for setting the correct scrollHeight for current values
  $('[data-expand~=auto]').each( function() {
    $(this).css({'padding': '0.375rem 0.75rem', 'height': this.scrollHeight});
  });

  // Handler for setting the correct scrollHeight on keyboard input
  $('[data-expand~=auto]').on('keyup', function(e) {
    $(this).css({
      'padding': '0.375rem 0.75rem',
      'height': '1px'
    }).css({
      'padding': '0.375rem 0.75rem',
      'height': this.scrollHeight + 2
    });
  });

  // Handler for triggering the preview on keyboard input
  $('[data-behavior~=preview-enabled]').on('textchange load-preview', function () {
    clearTimeout(typingTimer);
    typingTimer = setTimeout($textileData._onKeyPressPreview.bind($textileData, 'form'), 500);
  });
});
